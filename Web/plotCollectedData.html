<!DOCTYPE html>
<html>
<head>
<script src="http://code.jquery.com/jquery-1.9.1.js"></script>
<script src="http://maps.googleapis.com/maps/api/js"></script>
<script src="two.js"></script>
<script src="url.js"></script>
<script>
var controlPanelHeight = 100;
var fileSelectorWidth = 250;
var nrMarkers = 1000;
var map;
var two;

function googleMapInitialize() {
	//console.log('screen-height: ' + window.innerHeight);
	//console.log('screen-width: ' + window.innerWidth);
	var mapProp = {
		center:new google.maps.LatLng(34.0638202,-118.451060),
		zoom:16,
		mapTypeId:google.maps.MapTypeId.ROADMAP
	};
	map = new google.maps.Map(document.getElementById("googleMap"),mapProp);
	console.log('first', map);
}
google.maps.event.addDomListener(window, 'load', googleMapInitialize);
function hslToRgb(h, s, l){
	var r, g, b;

	if(s == 0){
		r = g = b = Math.round(l * 255); // achromatic
	}else{
		function hue2rgb(p, q, t){
			if(t < 0) t += 1;
			if(t > 1) t -= 1;
			if(t < 1/6) return p + (q - p) * 6 * t;
			if(t < 1/2) return q;
			if(t < 2/3) return p + (q - p) * (2/3 - t) * 6;
			return p;
		}

		var q = l < 0.5 ? l * (1 + s) : l + s - l * s;
		var p = 2 * l - q;
		r = Math.round( hue2rgb(p, q, h + 1/3) * 255 );
		g = Math.round( hue2rgb(p, q, h)       * 255 );
		b = Math.round( hue2rgb(p, q, h - 1/3) * 255 );
	}
	return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
	//return [Math.round(r * 255), Math.round(g * 255), Math.round(b * 255)];
}

function regulateSize() {
	var wh = window.innerHeight;
	var ww = window.innerWidth;
	$('#top').height(wh - controlPanelHeight);
	$('#googleMap').width(ww - fileSelectorWidth);
	$('#fileSelector').width(fileSelectorWidth);
	$('#fileSelector').css({left:(ww - fileSelectorWidth)});
	$('#controlPanel').height(controlPanelHeight);
	two.height = $('#controlPanel').height();
	two.width = $('#controlPanel').width();
	two.update();
	drawColorBar();
}

function drawColorBar() {
	for (var i = 0; i < two.colorLine.length; i++)
		two.remove(two.colorLine[i]);
	two.colorLine = [];

	var dh = $('#controlPanel').height();
	var dw = $('#controlPanel').width();
	for (var i = 0; i < dw - 200; i++) {
		var line = two.makeLine(i+100, 10, i+100, 25);
		line.linewidth = 1;
		lv = Math.min(two.cursor[0], two.cursor[1]);
		uv = Math.max(two.cursor[0], two.cursor[1]);
		darkness = (lv < i && i < uv) ? 0.5 : 0.2;
		line.stroke = hslToRgb(Number(i) / (dw-200.0) * 0.7, 0.8, darkness);
		two.colorLine.push(line);
	}
	two.update();
}

function captureCursorDown(me) {
	var sh = $('#controlPanel').offset().top;
	var dw = $('#controlPanel').width();
	if (sh + 10 <= me.clientY && me.clientY <= sh + 25 && 70 < me.clientX && me.clientX <= dw - 70) {
		var d0 = Math.abs(me.clientX - two.cursor[0] - 100);
		var d1 = Math.abs(me.clientX - two.cursor[1] - 100);
		var dmin = Math.min(d0, d1);
		if (dmin < 30) {
			two.cursorFocus = (d0 < d1) ? 0 : 1;
			keepRepaintingColorBar();
		}
	}
}

function captureCursorMove(me) {
	var sh = $('#controlPanel').offset().top;
	var dw = $('#controlPanel').width();
	if (two.cursorFocus != -1 && me.clientY <= sh + 30 && 70 <= me.clientX && me.clientX <= dw - 70) {
		var tx = me.clientX - 100;
		if (tx < 0)
			tx = 0;
		if (tx > dw - 200)
			tx = dw - 200;
		two.cursor[ two.cursorFocus ] = tx;
	}
}

function keepRepaintingColorBar() {
	drawColorBar();
	dw = $('#controlPanel').width() - 200;
	ia = Math.floor( Number( Math.min(two.cursor[0], two.cursor[1])) / dw * gpsData.length );
	ib = Math.floor( Number( Math.max(two.cursor[0], two.cursor[1])) / dw * gpsData.length );
	d = ib - ia + 1;
	for (i = 0; i < gpsData.length; i++)
		gpsData[i].marker.setVisible(ia <= i && i <= ib && Math.floor(Number(i - ia) / d * nrMarkers) != Math.floor(Number(i - ia + 1) / d * nrMarkers) );
	console.log(new Date().getTime(), 'drawn', ia, ib);
	if (two.cursorFocus != -1)
		setTimeout(keepRepaintingColorBar, 50);
}

// ---- Web socket --------------------------------------------------------
function loadFileList() {
	var ws = new WebSocket('ws://localhost:8888/collect/ls');
	var checkpoint = false;
	ws.onopen = function() {
		// Web Socket is connected, send data using send()
		//ws.send("Message to send");
		console.log("ls open");
	};
	ws.onmessage = function (evt)  { 
		var rcvStr = evt.data;
		console.log("Message is received...", rcvStr);
		var rcvObj = $.parseJSON(rcvStr);
		for (var i = 0; i < rcvObj.items.length; i++) {
			$("#fileList").append(new Option(rcvObj.items[i], rcvObj.items[i]));
		}
		checkpoint = true;
	};
	ws.onclose = function() { 
		// websocket is closed.
		console.log("Connection is closed..."); 
		if (checkpoint == false)
			alert("cannot connect to server");
	};
	console.log('test2 finish');
}

gpsData = null;
function loadTrajectory(filename) {
	if (gpsData) {
		for (var i = 0; i < gpsData.length; i++)
			gpsData[i].marker.setMap(null);
	}

	var ws = new WebSocket('ws://localhost:8888/collect/load/' + filename);
	var checkpoint = false;
	var tmpGpsData = [];
	ws.onopen = function() {
		console.log("ls open");
	};
	ws.onmessage = function (evt)  { 
		var rcvStr = evt.data;
		console.log("Message is received...", rcvStr);
		var rcvObj = $.parseJSON(rcvStr);

		for (var i = 0; i < rcvObj.items.length; i++) {
			var eles = rcvObj.items[i].split(",");
			var ttime = Number(eles[0]);
			var marker = new google.maps.Marker({
				position: new google.maps.LatLng(parseFloat(eles[1]), parseFloat(eles[2])),
				icon: {
					path: google.maps.SymbolPath.BACKWARD_CLOSED_ARROW,
					strokeWeight: 1,
					strokeColor: hslToRgb(i / rcvObj.items.length * 0.7, 0.8, 0.5),
					scale: 2,
				},
				map: map
			});
			marker.setVisible(Math.floor(Number(i) / rcvObj.items.length * nrMarkers) != Math.floor(Number(i+1) / rcvObj.items.length * nrMarkers) );
			tmpGpsData.push({time:ttime, marker:marker});
			console.log(i, ttime, parseFloat(eles[1]), parseFloat(eles[2]), eles);
		}
		checkpoint = true;
		gpsData = tmpGpsData;
	};
	ws.onclose = function() { 
		// websocket is closed.
		var dw = $('#controlPanel').width();
		two.cursorFocus = -1;
		console.log("Connection is closed..."); 
		if (checkpoint == false) {
			alert("cannot connect to server");
			two.cursor = [-100, -100];
		}
		else {
			two.cursor = [0, dw - 200];
		}
		drawColorBar();
	};
	console.log('loadTrajectory finished');
}

</script>
</head>

<body style='margin:0; padding:0; overflow:hidden' body onresize="regulateSize()" onmouseup="two.cursorFocus=-1">
<div id="top" style="width:100%; position: relative">
	<div id="googleMap" style="width:500px;height:100%;position:absolute"></div>
	<div id="fileSelector" style="background-color: rgb(255, 233, 233); height:100%; float:right; position:absolute">
		<select id='fileList' name="sometext" multiple='multiple' style='width:100%; height:100%' onchange="loadTrajectory(this.options[this.selectedIndex].text);">
		</select>
	</div>
</div>
<div id="controlPanel" style="background-color: rgb(255, 255, 200); width:100%" onmousedown="captureCursorDown(event)" onmousemove="captureCursorMove(event)"></div>
	
<script>
var elem = document.getElementById("controlPanel")
two = new Two({type: Two.Types['webgl']});
two.appendTo(elem);
two.colorLine = [];
two.cursor = [-100, -100];
two.cursorFocus = -1;
regulateSize();
loadFileList();
</script>
</body>

</html> 
